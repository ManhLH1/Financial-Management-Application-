name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Cho phÃ©p cháº¡y manual tá»« GitHub UI

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Setup Java (cáº§n cho Android build)
      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 4. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 5. Build Next.js app
      - name: ğŸ—ï¸ Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production

      # 6. Setup Android SDK
      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      # 7. Sync Capacitor
      - name: âš¡ Sync Capacitor
        run: npx cap sync android

      # 8. Grant execute permission for gradlew
      - name: ğŸ” Grant execute permission for gradlew
        run: chmod +x android/gradlew

      # 9. Build APK (Release)
      - name: ğŸ”¨ Build Android APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}

      # 10. Upload APK as artifact
      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: financial-manager-apk-${{ github.run_number }}
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30

      # 11. Create Release (optional - chá»‰ khi push tag)
      - name: ğŸ‰ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/release/app-release-unsigned.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. Comment on PR with download link (náº¿u lÃ  PR)
      - name: ğŸ’¬ Comment APK download link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… APK build thÃ nh cÃ´ng! ğŸ‰\n\nDownload APK tá»« [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            })
